pico-8 cartridge // http://www.pico-8.com
version 39
__lua__

#include utils.lua
#include animation.lua

function _init()
   g_anims={}
   frame_count = 1
   rain_particles = {}
   wind = 0
end

function animate_rain(obj)
   while obj.y < 125 do
      obj.x += wind > 0 and rnd() or 0
      obj.y += obj.speed
      yield()
   end

   obj.splashing = true
   for i = 1,7 do
      obj.sprite = i
      wait(2+randx(2))
   end
   wait(1)
end

function rand_tile_x()
   local x = -96+randx(224)
   x = x - (x % 3)
   function occupies_tile(p)
      return p.y < 1 and p.x == x
   end
   while any(rain_particles, occupies_tile) do
      x = -96+randx(224)
      x = x - (x % 3)
   end
   return x
end

function _update60()
   run_animations()

   if frame_count % 20 == 0 then
      for i = 1,20 do
         local rain_particle = make_obj({
               x = rand_tile_x(),
               y = -randx(10),
               speed = 0.75+rnd(),
               splashing = false,
               sprite = 1
         })
         add(rain_particles, rain_particle)
         animate_obj(rain_particle, animate_rain)
      end
   end

   if frame_count % 360 == 0 then
      wind = wind == 0 and 1 or 0
   end

   for idx, p in pairs(rain_particles) do
      if not p.animating then
         deli(rain_particles, idx)
      end
   end

   frame_count += 1
end

function draw_rain(p)
   local is_slow = p.speed < 1.25
   if p.splashing then
      local s = is_slow and p.sprite or p.sprite+16
      spr(s, p.x, 120)
   else
      local c = is_slow and storm or slate
      line(p.x, p.y, p.x-wind, p.y-3, c)
      pset(p.x, p.y+1, dusk)
   end
end

function _draw()
   pal(black,midnight,1)
   cls(black)
   for p in all(rain_particles) do
      if p.speed < 1.25 then
         draw_rain(p)
      end
   end
   for p in all(rain_particles) do
      if p.speed >= 1.25 then
         draw_rain(p)
      end
   end
end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000100000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000001000100060006000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000010100000d0d00000d0d00010d0d01000101000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000100000001000000060000000600000006000001060100001610000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000100000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000001000100010001000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000010100000101000001010001010101000101000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000100000001000000010000000100000001000001010100001110000000000000000000000000000000000000000000000000000000000000000000
